---
layout:     post
title:      分布式事务及其解决方案
subtitle:    "\"distribution transaction\""
date:       2020-07-31
author:     Jimmy
header-img: img/2020-07-08-second-kill-2020/sec_kill_backgroud.jpg
catalog: true
tags:
    - 分布式架构
---

# 数据库本地事务
## ACID
* A：原子性（Atomicity）

一个事务中的所有操作，要么全部完成，要么全部不完成，不会在中间的某个环节结束。事务在执行过程中发送错误，就会被回滚到事务开始前的状态。

* C：一致性（Consistency）

一个事务执行之前和执行之后数据库都必须处于一致性状态。比如A转账10块钱给B，那么最终完成时的状态一定是，A账户少了10块钱，B账户多了10块钱，A+B账户钱总量是不变的。

* I：隔离性（Isolation）

在并发环境中，当不同的事务操作相同数据时，每个事务都有各自完整的数据空间，由并发事务所做的修改必须与任何其他并发事务所做修改隔离。

* D：持久性（Durability）

只要事务成功结束，它对数据库的更新就必须永久保存下来。


# 分布式事务

## 什么是分布式事务

通俗的说，就是一次大的操作由不同的小操作组成，而这些小操作分布在不同的服务器上，且属于不同的应用，分布式事务需要保证这些小操作要么全部成功，要么全部失败。

## 分布式事务产生原因

主要可以分为两类，一类是service产生多个节点，另一类是resource产生多个节点。

### service多个节点 -- 微服务架构

![](https://github.com/linbing1219/linbing1219.github.io/raw/master/img/2020-07-31-distributed-transaction-2020/order_service_pic.jpg)


### resource多个节点 -- 单系统多库访问

![](https://github.com/linbing1219/linbing1219.github.io/raw/master/img/2020-07-31-distributed-transaction-2020/multi_db.jpg)



# 分布式事务基础理论

## CAP

*  C (一致性): 对某个指定的客户端来说，读操作能返回最新的写操作。对于数据分布在不同节点上的数据上来说，如果在某个节点更新了数据，那么在其他节点如果都能读取到这个最新的数据，那么就称为强一致，如果有某个节点没有读取到，那就是分布式不一致。

* A (可用性)：非故障的节点在合理的时间内返回合理的响应(不是错误和超时的响应)。可用性的两个关键一个是合理的时间，一个是合理的响应。合理的时间指的是请求不能无限被阻塞，应该在合理的时间给出返回。合理的响应指的是系统应该明确返回结果并且结果是正确的，这里的正确指的是比如应该返回50，而不是返回40。

* P (分区容错性):当出现网络分区后，系统能够继续工作。打个比方，这里个集群有多台机器，有台机器网络出现了问题，但是这个集群仍然可以正常工作。

CAP三者不能共有，要么CP，要么AP。

## BASE

BASE 是 Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写。是对CAP中AP的一个扩展。

1. 基本可用:分布式系统在出现故障时，允许损失部分可用功能，保证核心功能可用。
1. 软状态:允许系统中存在中间状态，这个状态不影响系统可用性，这里指的是CAP中的不一致。
1. 最终一致:最终一致是指经过一段时间后，所有节点数据都将会达到一致。

BASE解决了CAP中理论没有网络延迟，在BASE中用软状态和最终一致，保证了延迟后的一致性。BASE和 ACID 是相反的，它完全不同于ACID的强一致性模型，而是通过牺牲强一致性来获得可用性，并允许数据在一段时间内是不一致的，但最终达到一致状态。

# 分布式事务解决方案

## 2PC

## TCC

- TODO

## 参考资料

[再有人问你分布式事务，把这篇扔给他](https://juejin.im/post/6844903647197806605)